package net.dappls.legacy_utils.Toggles;


import net.dappls.legacy_utils.client.Util.ChatUtils;
import net.fabricmc.api.EnvType;
import net.fabricmc.api.Environment;
import net.fabricmc.fabric.api.client.event.lifecycle.v1.ClientTickEvents;
import net.fabricmc.fabric.api.client.rendering.v1.WorldRenderEvents;
import net.minecraft.client.MinecraftClient;
import net.minecraft.client.render.Camera;
import net.minecraft.client.render.RenderLayer;
import net.minecraft.client.render.VertexConsumer;
import net.minecraft.client.render.VertexConsumerProvider;
import net.minecraft.client.util.math.MatrixStack;
import net.minecraft.util.math.BlockPos;

import java.awt.*;
import java.util.ArrayList;
import java.util.List;

import static net.dappls.legacy_utils.client.Util.TrailRenderer.renderCube;

@Environment(EnvType.CLIENT)
public class DungeonParticleTrail {

    public enum DungeonTrailMode {
        OFF,
        LAMP1,
        LAMP2,
        LAMP3,
        WINDCHARGE;

        public DungeonTrailMode next() {
            return values()[(this.ordinal() + 1) % values().length];
        }
    }

    private static DungeonTrailMode currentMode = DungeonTrailMode.OFF;

    private static final List<BlockPos> Lamp1Path = new ArrayList<>();
    private static final List<BlockPos> Lamp2Path = new ArrayList<>();
    private static final List<BlockPos> Lamp3Path = new ArrayList<>();
    private static final List<BlockPos> WindChargePath = new ArrayList<>();

    private static final List<BlockPos> activeTrail = new ArrayList<>();


    private static final int[][] Lamp1Coords = {{10019, 136, 50537}, {10019, 136, 50536}, {10019, 136, 50535}, {10019, 136, 50534}, {10019, 136, 50533}, {10019, 137, 50532}, {10019, 137, 50531}, {10019, 138, 50531}, {10019, 138, 50530}, {10019, 139, 50530}, {10019, 139, 50529}, {10020, 139, 50529}, {10020, 139, 50528}, {10020, 139, 50527}, {10019, 139, 50527}, {10019, 139, 50526}, {10019, 139, 50527}, {10018, 139, 50527}, {10018, 139, 50526}, {10018, 139, 50525}, {10018, 140, 50525}, {10018, 140, 50524}, {10018, 140, 50523}, {10018, 140, 50522}, {10017, 140, 50522}, {10016, 140, 50522}, {10015, 140, 50522}, {10015, 140, 50521}, {10015, 141, 50520}, {10016, 141, 50520}, {10016, 141, 50519}, {10016, 141, 50518}, {10017, 141, 50518}, {10017, 142, 50518}, {10018, 142, 50518}, {10019, 142, 50518}, {10019, 142, 50519}, {10020, 142, 50519}, {10020, 142, 50520}, {10020, 143, 50520}, {10020, 143, 50521}, {10020, 143, 50522}, {10020, 143, 50523}, {10021, 143, 50524}, {10021, 144, 50524}, {10021, 144, 50525}, {10022, 144, 50525}, {10022, 144, 50526}, {10022, 143, 50526}, {10023, 143, 50527}, {10024, 143, 50527}, {10024, 144, 50527}, {10025, 144, 50527}, {10024, 144, 50527}, {10024, 144, 50526}, {10025, 144, 50526}, {10026, 144, 50526}, {10027, 145, 50526}, {10028, 145, 50526}, {10029, 145, 50526}, {10030, 145, 50526}, {10030, 145, 50527}, {10030, 145, 50526}, {10030, 145, 50525}, {10030, 146, 50525}, {10030, 146, 50524}, {10030, 147, 50524}, {10030, 148, 50523}, {10030, 148, 50522}, {10029, 148, 50522}, {10028, 148, 50522}, {10028, 149, 50522}, {10027, 149, 50522}, {10026, 149, 50522}, {10026, 148, 50522}, {10025, 148, 50522}, {10025, 148, 50523}, {10024, 148, 50523}, {10025, 148, 50523}, {10025, 148, 50524}, {10025, 148, 50525}, {10025, 149, 50525}, {10025, 149, 50526}, {10026, 149, 50526}, {10026, 149, 50527}, {10026, 149, 50528}, {10026, 148, 50528}, {10026, 148, 50529}, {10027, 148, 50529}, {10027, 149, 50529}, {10027, 149, 50528}, {10027, 149, 50529}, {10028, 149, 50529}, {10028, 149, 50530}, {10028, 148, 50531}, {10028, 147, 50531}, {10028, 147, 50532}, {10029, 147, 50532}, {10028, 147, 50532}, {10028, 147, 50533}, {10027, 147, 50533}, {10027, 148, 50533}, {10026, 148, 50533}, {10026, 148, 50534}, {10025, 148, 50534}, {10024, 147, 50534}, {10024, 147, 50535}, {10023, 146, 50535}, {10022, 146, 50535}, {10021, 146, 50535}, {10021, 146, 50536}, {10021, 146, 50537}, {10021, 145, 50537}, {10021, 145, 50538}, {10022, 145, 50538}, {10022, 145, 50539}, {10023, 145, 50539}, {10023, 145, 50538}};
    private static final int[][] Lamp2Coords = {{10023, 145, 50538}, {10022, 145, 50538}, {10021, 145, 50538}, {10021, 145, 50537}, {10021, 146, 50537}, {10021, 146, 50536}, {10021, 146, 50535}, {10021, 146, 50534}, {10022, 146, 50534}, {10023, 146, 50535}, {10023, 146, 50534}, {10023, 147, 50534}, {10023, 148, 50533}, {10023, 149, 50532}, {10023, 149, 50531}, {10023, 150, 50531}, {10024, 150, 50531}, {10023, 150, 50531}, {10023, 150, 50530}, {10024, 150, 50530}, {10024, 150, 50531}, {10025, 150, 50531}, {10025, 151, 50531}, {10026, 151, 50531}, {10027, 151, 50531}, {10027, 150, 50532}, {10028, 150, 50532}, {10028, 149, 50532}, {10029, 148, 50532}, {10029, 147, 50532}, {10028, 147, 50532}, {10029, 147, 50532}, {10029, 148, 50533}, {10030, 148, 50533}, {10031, 148, 50534}, {10031, 147, 50534}, {10032, 147, 50535}, {10032, 146, 50535}, {10032, 146, 50536}, {10031, 146, 50536}, {10032, 147, 50536}, {10032, 147, 50537}, {10032, 147, 50538}, {10033, 147, 50538}, {10033, 148, 50538}, {10034, 148, 50538}, {10034, 148, 50539}, {10034, 149, 50539}, {10034, 149, 50540}, {10035, 149, 50540}, {10035, 149, 50541}, {10035, 148, 50541}, {10036, 148, 50542}, {10036, 148, 50541}, {10035, 148, 50541}, {10036, 148, 50541}, {10036, 148, 50542}, {10037, 148, 50542}, {10037, 149, 50542}, {10038, 149, 50543}, {10038, 149, 50544}, {10039, 149, 50544}, {10039, 148, 50544}, {10039, 148, 50545}, {10039, 149, 50545}, {10040, 149, 50545}, {10040, 149, 50546}, {10040, 150, 50546}, {10040, 150, 50547}, {10040, 150, 50548}, {10040, 149, 50548}, {10040, 150, 50549}, {10040, 150, 50550}, {10040, 151, 50550}, {10040, 151, 50551}, {10041, 151, 50551}, {10040, 151, 50551}, {10039, 151, 50550}, {10039, 152, 50550}, {10038, 152, 50550}, {10037, 152, 50550}, {10036, 151, 50550}, {10036, 150, 50550}, {10035, 150, 50550}, {10035, 150, 50551}};
    private static final int[][] Lamp3Coords ={{10018, 136, 50536}, {10018, 136, 50535}, {10018, 136, 50534}, {10019, 136, 50534}, {10019, 136, 50533}, {10019, 137, 50532}, {10019, 137, 50531}, {10019, 138, 50531}, {10019, 138, 50530}, {10019, 139, 50530}, {10020, 139, 50530}, {10020, 139, 50529}, {10020, 139, 50528}, {10020, 139, 50527}, {10019, 139, 50527}, {10019, 139, 50526}, {10019, 139, 50525}, {10019, 140, 50525}, {10019, 140, 50524}, {10018, 140, 50524}, {10018, 140, 50523}, {10018, 140, 50522}, {10017, 140, 50522}, {10016, 140, 50522}, {10016, 140, 50523}, {10015, 140, 50523}, {10014, 140, 50523}, {10014, 141, 50523}, {10013, 141, 50523}, {10012, 141, 50523}, {10011, 141, 50523}, {10012, 141, 50523}, {10011, 141, 50523}, {10010, 142, 50522}, {10009, 142, 50522}, {10009, 143, 50522}, {10008, 143, 50522}, {10008, 144, 50522}, {10008, 144, 50521}, {10007, 144, 50521}, {10007, 144, 50522}, {10008, 144, 50522}, {10007, 144, 50521}, {10007, 144, 50520}, {10007, 145, 50520}, {10007, 145, 50519}, {10007, 145, 50518}, {10007, 145, 50517}, {10007, 145, 50518}, {10007, 145, 50517}, {10007, 145, 50516}, {10007, 146, 50516}, {10007, 146, 50515}, {10007, 146, 50514}, {10008, 146, 50514}, {10008, 146, 50513}, {10007, 146, 50513}, {10007, 146, 50514}, {10008, 146, 50514}, {10009, 147, 50514}, {10010, 147, 50515}, {10011, 148, 50515}, {10011, 148, 50516}, {10011, 149, 50516}, {10011, 150, 50517}, {10011, 151, 50518}, {10011, 151, 50519}, {10011, 151, 50518}, {10011, 151, 50517}, {10011, 152, 50517}, {10011, 152, 50516}, {10011, 152, 50515}, {10010, 152, 50515}, {10010, 151, 50515}, {10010, 151, 50514}, {10009, 151, 50514}, {10009, 151, 50513}, {10009, 152, 50513}, {10009, 152, 50512}, {10009, 152, 50511}, {10009, 152, 50510}, {10010, 152, 50510}, {10011, 152, 50511}, {10011, 153, 50511}, {10012, 153, 50511}, {10013, 153, 50511}, {10014, 153, 50511}, {10014, 153, 50510}, {10015, 154, 50510}, {10016, 154, 50510}, {10017, 154, 50510}, {10017, 154, 50509}, {10017, 155, 50509}, {10017, 155, 50508}, {10017, 156, 50508}, {10016, 156, 50508}, {10017, 156, 50508}, {10018, 156, 50508}, {10018, 157, 50509}, {10019, 157, 50509}, {10020, 157, 50509}, {10020, 156, 50509}, {10021, 156, 50509}, {10021, 155, 50509}, {10021, 154, 50510}, {10022, 153, 50510}, {10022, 152, 50510}, {10023, 151, 50510}, {10023, 150, 50510}, {10023, 150, 50511}, {10024, 150, 50511}, {10025, 150, 50510}, {10025, 151, 50510}, {10026, 151, 50510}, {10027, 151, 50510}, {10028, 151, 50510}, {10028, 150, 50510}, {10029, 149, 50510}, {10029, 148, 50510}, {10030, 147, 50510}, {10030, 147, 50511}, {10029, 147, 50511}};
    private static final int[][] WindChargeCoords = {{10018, 136, 50537}, {10018, 136, 50536}, {10018, 136, 50535}, {10019, 136, 50535}, {10019, 136, 50534}, {10019, 136, 50533}, {10019, 137, 50532}, {10019, 138, 50531}, {10019, 138, 50530}, {10019, 139, 50530}, {10020, 139, 50530}, {10020, 139, 50529}, {10020, 139, 50528}, {10020, 139, 50527}, {10019, 139, 50527}, {10019, 139, 50526}, {10019, 139, 50525}, {10019, 140, 50525}, {10019, 140, 50524}, {10018, 140, 50524}, {10018, 140, 50523}, {10018, 140, 50522}, {10017, 140, 50522}, {10016, 140, 50522}, {10015, 140, 50522}, {10014, 140, 50522}, {10014, 141, 50522}, {10013, 141, 50522}, {10012, 141, 50522}, {10011, 141, 50522}, {10010, 142, 50522}, {10009, 142, 50522}, {10009, 143, 50522}, {10008, 144, 50521}, {10007, 144, 50521}, {10007, 144, 50520}, {10007, 145, 50520}, {10007, 145, 50519}, {10007, 145, 50518}, {10007, 145, 50517}, {10007, 145, 50516}, {10007, 146, 50515}, {10008, 146, 50514}, {10008, 146, 50513}, {10007, 146, 50513}, {10008, 146, 50514}, {10008, 147, 50514}, {10009, 147, 50514}, {10010, 147, 50514}, {10010, 147, 50515}, {10010, 148, 50515}, {10011, 148, 50515}, {10011, 149, 50516}, {10010, 149, 50517}, {10010, 150, 50517}, {10010, 150, 50518}, {10010, 151, 50518}, {10010, 151, 50519}, {10010, 151, 50518}, {10010, 151, 50517}, {10010, 152, 50517}, {10010, 152, 50516}, {10010, 152, 50515}, {10010, 151, 50515}, {10010, 151, 50514}, {10010, 151, 50513}, {10010, 152, 50513}, {10010, 152, 50512}, {10010, 152, 50511}, {10010, 152, 50510}, {10011, 152, 50510}, {10011, 153, 50510}, {10012, 153, 50510}, {10013, 153, 50510}, {10014, 153, 50510}, {10014, 154, 50510}, {10015, 154, 50510}, {10016, 154, 50510}, {10017, 154, 50510}, {10017, 154, 50509}, {10017, 155, 50509}, {10017, 155, 50508}, {10017, 156, 50508}, {10016, 156, 50508}, {10017, 156, 50508}, {10017, 156, 50509}, {10017, 157, 50509}, {10018, 157, 50509}, {10018, 157, 50510}, {10019, 156, 50510}, {10019, 155, 50511}, {10020, 154, 50511}, {10020, 153, 50511}, {10019, 153, 50511}, {10019, 153, 50512}, {10020, 153, 50512}, {10020, 154, 50513}, {10021, 154, 50513}, {10021, 154, 50514}, {10022, 154, 50514}, {10022, 153, 50515}, {10022, 152, 50515}, {10022, 153, 50516}, {10022, 153, 50517}, {10022, 154, 50517}, {10023, 154, 50518}, {10023, 155, 50518}, {10023, 155, 50519}, {10022, 155, 50519}, {10021, 155, 50519}, {10021, 155, 50520}, {10021, 155, 50521}, {10022, 155, 50521}, {10022, 155, 50522}, {10021, 155, 50522}, {10022, 155, 50522}, {10022, 155, 50523}, {10023, 155, 50523}, {10023, 156, 50523}, {10024, 156, 50523}, {10025, 156, 50523}, {10025, 157, 50523}, {10024, 157, 50524}, {10024, 158, 50524}, {10024, 159, 50525}, {10024, 159, 50526}, {10024, 160, 50526}, {10024, 160, 50527}, {10025, 160, 50527}, {10026, 161, 50527}, {10026, 161, 50528}, {10026, 161, 50527}, {10026, 161, 50528}, {10026, 161, 50527}, {10025, 161, 50527}, {10025, 161, 50526}, {10025, 162, 50526}, {10025, 162, 50525}, {10025, 162, 50524}, {10024, 162, 50524}, {10024, 161, 50523}, {10024, 160, 50522}, {10024, 160, 50523}, {10023, 160, 50523}, {10022, 160, 50523}, {10022, 161, 50523}, {10021, 161, 50523}, {10021, 161, 50524}, {10020, 161, 50524}, {10020, 160, 50524}, {10019, 160, 50524}, {10019, 159, 50524}, {10018, 158, 50525}, {10018, 159, 50525}, {10019, 159, 50525}, {10019, 159, 50526}, {10019, 160, 50526}, {10019, 160, 50527}, {10019, 160, 50526}, {10020, 160, 50527}, {10020, 161, 50527}, {10020, 161, 50528}, {10021, 161, 50528}, {10021, 161, 50529}, {10021, 160, 50529}, {10022, 159, 50530}, {10021, 159, 50530}, {10021, 160, 50530}, {10021, 160, 50529}, {10020, 160, 50530}, {10020, 161, 50530}, {10019, 161, 50530}, {10018, 161, 50530}, {10018, 161, 50531}, {10018, 161, 50532}, {10018, 162, 50532}, {10017, 162, 50532}, {10017, 162, 50533}, {10017, 162, 50534}, {10017, 161, 50534}, {10016, 161, 50534}, {10016, 161, 50535}, {10016, 161, 50536}, {10015, 161, 50536}, {10015, 162, 50536}, {10014, 162, 50536}, {10014, 163, 50536}, {10013, 163, 50536}, {10014, 163, 50536}, {10014, 163, 50537}, {10014, 164, 50537}, {10015, 164, 50537}, {10015, 164, 50538}, {10016, 164, 50538}, {10016, 163, 50539}, {10015, 163, 50539}, {10016, 163, 50539}, {10017, 163, 50539}, {10017, 164, 50539}, {10018, 164, 50539}, {10019, 164, 50539}, {10019, 165, 50538}, {10019, 165, 50537}, {10020, 164, 50536}, {10020, 164, 50535}, {10019, 164, 50535}, {10019, 164, 50534}, {10019, 164, 50535}, {10018, 164, 50535}, {10018, 164, 50534}, {10018, 164, 50533}, {10018, 165, 50533}, {10017, 165, 50533}, {10017, 165, 50532}, {10017, 165, 50531}, {10017, 164, 50531}, {10017, 164, 50530}, {10016, 164, 50530}, {10016, 164, 50531}, {10015, 164, 50531}, {10015, 164, 50530}, {10015, 165, 50530}, {10014, 165, 50530}, {10014, 165, 50529}, {10013, 165, 50529}, {10013, 164, 50529}, {10013, 164, 50528}, {10013, 164, 50527}, {10013, 165, 50527}, {10013, 165, 50526}, {10013, 165, 50525}, {10013, 165, 50524}, {10013, 166, 50524}, {10013, 166, 50523}, {10013, 166, 50522}, {10013, 165, 50522}, {10014, 165, 50522}, {10013, 165, 50522}, {10013, 165, 50523}, {10014, 165, 50523}, {10015, 165, 50523}, {10015, 166, 50523}, {10016, 166, 50523}, {10017, 166, 50522}, {10017, 165, 50522}, {10018, 165, 50522}, {10019, 166, 50522}, {10020, 166, 50522}, {10021, 166, 50522}, {10021, 165, 50522}, {10022, 164, 50522}, {10022, 163, 50522}, {10021, 163, 50522}, {10021, 164, 50522}, {10020, 165, 50521}, {10019, 165, 50521}, {10019, 165, 50520}, {10019, 164, 50520}, {10019, 163, 50520}, {10019, 162, 50520}, {10019, 162, 50519}, {10019, 162, 50518}, {10018, 162, 50518}, {10018, 162, 50519}, {10019, 162, 50519}, {10020, 162, 50519}, {10020, 163, 50519}, {10021, 163, 50519}, {10022, 163, 50519}, {10023, 163, 50519}, {10023, 162, 50519}, {10024, 162, 50519}, {10025, 162, 50519}, {10024, 162, 50519}, {10025, 162, 50519}, {10025, 163, 50519}, {10026, 163, 50519}, {10027, 163, 50519}, {10027, 162, 50519}, {10028, 162, 50519}, {10029, 162, 50519}, {10030, 162, 50519}, {10031, 162, 50519}, {10031, 163, 50519}, {10032, 163, 50519}, {10033, 163, 50519}, {10033, 162, 50519}, {10033, 162, 50520}, {10032, 162, 50520}, {10032, 163, 50520}, {10032, 163, 50519}, {10031, 163, 50519}, {10032, 163, 50519}, {10033, 164, 50519}, {10034, 164, 50519}, {10034, 164, 50518}, {10035, 164, 50518}, {10035, 163, 50518}, {10036, 163, 50518}, {10036, 162, 50518}, {10036, 161, 50518}, {10037, 160, 50518}, {10037, 160, 50519}, {10037, 160, 50518}, {10037, 161, 50517}, {10038, 161, 50517}, {10038, 161, 50516}, {10038, 161, 50515}, {10038, 160, 50515}, {10038, 160, 50514}, {10038, 161, 50513}, {10038, 161, 50512}, {10038, 161, 50511}, {10038, 160, 50511}, {10038, 160, 50510}, {10037, 160, 50510}, {10037, 161, 50510}, {10036, 162, 50510}, {10035, 162, 50510}, {10034, 162, 50510}, {10035, 162, 50510}, {10034, 162, 50510}, {10033, 162, 50510}, {10033, 163, 50510}, {10032, 163, 50510}, {10031, 163, 50510}, {10030, 162, 50510}, {10030, 162, 50511}, {10029, 162, 50511}, {10029, 163, 50511}, {10028, 163, 50511}, {10027, 163, 50511}, {10027, 164, 50511}, {10026, 164, 50511}, {10026, 165, 50511}, {10026, 165, 50512}, {10026, 165, 50511}, {10026, 165, 50512}, {10026, 165, 50511}, {10025, 165, 50511}, {10025, 165, 50510}, {10025, 166, 50510}, {10025, 166, 50509}, {10025, 166, 50508}, {10024, 166, 50508}, {10024, 165, 50508}, {10024, 165, 50507}, {10024, 164, 50507}, {10023, 163, 50506}, {10023, 164, 50506}, {10023, 163, 50506}, {10023, 163, 50507}, {10023, 163, 50508}, {10023, 164, 50508}, {10023, 164, 50509}, {10023, 164, 50510}, {10023, 164, 50511}, {10023, 164, 50512}};

    public static void init() {
        Lamp1Path.clear();
        Lamp2Path.clear();
        Lamp3Path.clear();
        WindChargePath.clear();

        for (int[] c : Lamp1Coords) Lamp1Path.add(new BlockPos(c[0], c[1], c[2]));
        for (int[] c : Lamp2Coords) Lamp2Path.add(new BlockPos(c[0], c[1], c[2]));
        for (int[] c : Lamp3Coords) Lamp3Path.add(new BlockPos(c[0], c[1], c[2]));
        for (int[] c : WindChargeCoords) WindChargePath.add(new BlockPos(c[0], c[1], c[2]));
    }

    public static void register() {
        init();
        WorldRenderEvents.AFTER_ENTITIES.register(context -> {
            MatrixStack matrices = context.matrixStack();
            Camera camera = context.camera();
            VertexConsumerProvider consumers = context.consumers();
            if (consumers == null || activeTrail.isEmpty()) return;

            VertexConsumer buffer = consumers.getBuffer(RenderLayer.getDebugQuads());
            int total = activeTrail.size();

            for (int i = 0; i < total; i++) {
                BlockPos pos = activeTrail.get(i);
                float hue = (float) i / total;
                Color color = Color.getHSBColor(hue, 1f, 1f);

                renderCube(
                        matrices, buffer, camera, pos,
                        color.getRed() / 255f,
                        color.getGreen() / 255f,
                        color.getBlue() / 255f
                );
            }
        });

        // Remove blocks player touches
        ClientTickEvents.END_CLIENT_TICK.register(client -> {
            if (client.world == null || currentMode == DungeonTrailMode.OFF) {
                activeTrail.clear();
                return;
            }
            removeTouchedTrailBlock();
        });
    }

    public static void updateActiveTrail() {
        activeTrail.clear();
        switch (currentMode) {
            case LAMP1 -> activeTrail.addAll(Lamp1Path);
            case LAMP2 -> activeTrail.addAll(Lamp2Path);
            case LAMP3 -> activeTrail.addAll(Lamp3Path);
            case WINDCHARGE -> activeTrail.addAll(WindChargePath);
        }
    }


    public static void cycleMode() {
        if (MinecraftClient.getInstance().world != null &&
                MinecraftClient.getInstance().world.isPlayerInRange(10019, 136, 50537, 500)) {
            currentMode = currentMode.next();
            updateActiveTrail();
        } else {
            MinecraftClient.getInstance().setScreen(null);
            ChatUtils.sendClientMessage("You are not within range of the puzzle!");
        }
    }

    public static DungeonTrailMode getCurrentMode() {
        return currentMode;
    }

    private static void removeTouchedTrailBlock() {
        if (MinecraftClient.getInstance().player == null || activeTrail.isEmpty()) return;

        BlockPos playerPos = MinecraftClient.getInstance().player.getBlockPos();
        int touchedIndex = -1;

        for (int i = 0; i < activeTrail.size(); i++) {
            BlockPos pos = activeTrail.get(i);
            if (playerPos.isWithinDistance(pos,1.0)) {
                touchedIndex = i;
                break;
            }
        }

        if (touchedIndex >= 0) {
            activeTrail.subList(0, touchedIndex + 1).clear();
        }
    }
}

